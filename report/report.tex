% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

% This is a simple template for a LaTeX document using the "article" class.
% See "book", "report", "letter" for other types of document.

\documentclass[11pt]{article} % use larger type; default would be 10pt

\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)

%%% Examples of Article customizations
% These packages are optional, depending whether you want the features they provide.
% See the LaTeX Companion or other references for full information.

%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information

\usepackage{graphicx} % support the \includegraphics command and options

% \usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
% These packages are all incorporated in the memoir class to one degree or another...

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%% SECTION TITLE APPEARANCE
\usepackage{sectsty}
\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

 \setlength{\parindent}{0pt}

\usepackage{amsmath, amssymb, amsthm}
\DeclareMathOperator{\EX}{\mathbb{E}}
\DeclareMathOperator{\Prob}{\mathbb{P}}
\DeclareMathOperator*{\argmax}{arg\,max}

\usepackage{xcolor}

\newtheorem*{assumption}{Assumption}
\newtheorem*{lemma}{Lemma}
%%% END Article customizations

%%% The "real" document content comes below...

\title{Advertising and Pricing}
\author{Gabriele Daglio, Federico Di Cesare, Jacopo Germano}
%\date{} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed 

\begin{document}
\maketitle

\section{The setting}

Advertising is used to attract users on an ecommerce website that sells only one type of item. Each user belongs to one of three classes, and the classes are determined by the combination of two binary features. For each class $c \in C$ the following functions are modeled:
\begin{itemize}
\item A stochastic number of daily clicks of new users (i.e., that have never clicked before on the ads), $N_{c,b}$, such that $\EX[N_{c,b}]=n(c,b)$, where $b \in B$ is a bid value. 
\item A conversion rate function providing the probability that a user will buy the item at a certain price,  $r(c,p)$, where $p \in P$ is the price.
\item A distribution probability $f(c)$ over the number of times the user will come back to the ecommerce website to buy that item by 30 days after the first purchase. In other words, when a user makes a purchase, they are somehow likely to make more purchases in the near future, and after that the user will leave the website forever. 
\item TODO COST PER CLICK?
\end{itemize}

A margin function $m(p)$, where $p \in P$ is a price TODO CONTINUA


\subsection{New Daily Clicks $N_{c,b}$}
\textit{Nota: Per poter trasformare $E[N_{c,b}]$ in $n(c,b)$, dato che $N_{c,b}$ deve essere discreta è necessario che $n(c,b)$ sia a sua volta già la media di una distribuzione sui valori discreti che i nuovi clicks giornalieri possono assumere. Per incorporare la stocasticità possiamo sommare a questi nuovi click un white noise discreto, quindi $N_{c,b}=X+\epsilon$, con $E[\epsilon]=0$ e  $E[X] = n(c,b)$. In questo modo possiamo sicuramente togliere l'expectation nel primo punto ma dobbiamo fare in modo che aggiungendo il noise non si vada mai sotto 0. idea: $X>k,|\epsilon| <=k$. L'obiettivo è generare una distribuzione discreta che abbia il valore minimo $k$ e media $n(c,b)$}
\newline
\newline

For each class $c$ and bid $b$ we define the discret random variable $N_{c,b}$ obtained as follows: $N_{c,b} = X_{c,b} + \eta_c$, where $X_{c,b}$ and $\eta_c$ are discrete random variables such that $\EX[X_{c,b}]=n(c,b)$ and $\EX[\eta_c]=0$. The variable $\eta_c$ represents a daily noise, and to ensure $\Prob(N_{c,b} < 0) = 0$ we assume that the smallest value that $X_{c,b}$ can take is larger than the absolute value of the smallest negative value that $\eta_c$ can assume.
\newline
\newline
We furthermore adopt the following assumption: 
\begin{assumption}[Agnostic Advertisor(forse meglio Publisher?)]
$n(c,b)=n(c)v(b)$.
\end{assumption}
In the assumption above, $v(b)$ represents the fact that higher bids will win more auctions and $n(c)$ represents the fact that, for each class, a different percentage of the users will belong to class $c$ \textit{and} click on the ad. The meaning of the Agnostic Advertisor assumption is that a change in the bid will change the number of users seeing the ad but will never change the percentage of users for each class. In other words, the advertisor does not know about the classes of the users.
\newline
\newline
In our implementation we defined:
\begin{itemize}
\item $n(c)=n_c$, for each class a constant $n_c > 0$ is randomly sampled when the environment is generated.
\item $v(b)=\frac{1}{1+e^{-\overline z(b-\overline b)}}$, where $\overline z$ and $\overline b$ are randomly sampled when the environment is generated. The function $v(b)$ is the same for all the classes.
\end{itemize}

\subsection{Conversion Rate $r(c,p)$}
For each class $c \in C$, the function $r_c(p)$ used to model the conversion rate of users belonging to that class must have the following properties:
\begin{itemize}
\item $r_c(0) \approx 1$: The user will be very likely to buy the product if it comes for free.
\item $\lim\limits_{p \to +\infty} r_c(p) = 0$: As the price goes to infinity, the probability that the user will buy it goes to zero.
\item $r_c(p)$ is monotonically decreasing with respect to p: an increase of the price will never increase the probability that the user will buy it.
\end{itemize}
The function $r(c,p)$ is then defined as: $r(c,p) := r_c(p)$.
Despite the fact that the functions $r_c(p)$ could be in principle defined in completely different ways, in our implementation we chose to use only (reflected, translated and horizontally scaled) sigmoidal functions:
\begin{align*}
r_c(p) = \frac{1}{1+e^{-z_c(P_c-p)}}
\end{align*}
Where $P_c$, the inflection point of the sigmoid, can be seen as the average reserve price of the users of the class and $z_c$ can be seen as the concentration of the reserve prices of the users around the average: if $z_c$ is small the reserve prices of the many users will be more distributed across the domain and the function will be more flat, while as $z_c$ grows the reserve prices of the many users will be more concentrated around the average and at the point $P_c$ there will be a rapid transition from "buy" to "don't buy".
\subsection{Future Visits $f(c)$}

More text.

\subsection{Cost per click $k(b)$}

More text.

\section{Step 1}
{\color{red}
The goal is to maximize the expected profit over a single day, where the future visits of a user that first purchased the product are considered to contribute in expected value to the profit of the day of the first visit.

\begin{align*}
\argmax_{p,b}{\sum_{c \in C}{n(c,b)r(c,p)(1+\EX[f(c)])m(p)-n(c,b)k(b)}}
\end{align*}

Where the term $(1+\EX[f(c)])$ represents the average total number of purchases of a user that decides to purchase the item for the first time and the term $n(c,b)r(c,p)$ represents the number of users of class c that will click on the ad and purchase the item for the first time.
\newline
\newline
\textit{NOTA: Se abbiamo una var bernoulli $D_{c,p,i}$ (nome provvisorio) che indica se il i-esimo utente della classe c ha comprato oppure no, con media $\EX[D_{c,p,i}]=r(c,p)$, possiamo esprimere l'expected value sull'esperimento eleatorio di un giorno.
Idem con le future visits: c'è la variabile $F_{c,i}$ con media $\EX[F_{c,i}]=f(c)$}
}
\newline
\newline
The goal is to maximize the expected profit over a single day, where the future visits of a user are considered to contribute in expected value to the profit of the day of the first visit.

\begin{align*}
ExpectedProfit(p,b) = \EX\left[\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}{\bigg( D_{c,p,i}(1+F_{c,i})m(p)-k(b)\bigg)}}\right]
\end{align*}
We can therefore formulate the optimization problem as follows:
\begin{align*}
\argmax_{p,b}{ExpectedProfit(p,b)}
\end{align*}

With some manipulations using the properties of the expectation (Appendix \ref{sec.DerExpProf}), the expected profit can be expressed as follows:

\begin{align*}
ExpectedProfit(p,b)=m(p)\sum_{c \in C}{n(c,b)r(c,p)(1+f(c))}-k(b)\sum_{c \in C}{n(c,b)}
\end{align*}

Obtaining the formulation:

\begin{align*}
\argmax_{p,b}{m(p)\sum_{c \in C}{n(c,b)r(c,p)(1+f(c))}-k(b)\sum_{c \in C}{n(c,b)}}
\end{align*}

Under the Agnostic Advertisor assumption, the following interesting result holds:

\begin{lemma}[Constant optimal price]
If a price $p*$ is a local maximum of $ExpectedProfit(p,\overline b)$ for some fixed bid value $\overline b$,  then $p*$ is a local maximum of $ExpectedProfit(p,b')$  for every possible fixed bid value $b'$.
\end{lemma}
\begin{proof}
see Appendix \ref{sec.ConstOptPrice}.
\end{proof}
{\color{red}
\begin{align*}
\EX\left[\sum_{i =1}^{N_{c,b}}{\bigg( D_{c,p,i}(1+F_{c,i})\bigg)}\right]=\EX\left[\sum_{i =1}^{N_{c,b}}{\EX[D_{c,p,i}(1+F_{c,i})]}\right]
\end{align*}

\textit{NOTA: cerca "Law of total expectation"}
\begin{align*}
\EX\left[\sum_{i =1}^{N_{c,b}}{\bigg( D_{c,p,i}(1+F_{c,i})\bigg)}\right]\\
=\sum_{j}{\Prob(N_{c,b}=j)\EX\left[\sum_{i =1}^{N_{c,b}}{\bigg( D_{c,p,i}(1+F_{c,i})\bigg)}|N_{c,b}=j\right]}\\
=\sum_{j}{\Prob(N_{c,b}=j)\EX\left[\sum_{i =1}^{j}{\bigg( D_{c,p,i}(1+F_{c,i})\bigg)}\right]}\\
=\sum_{j}{\Prob(N_{c,b}=j)\sum_{i =1}^{j}{\EX\left[ D_{c,p,i}(1+F_{c,i})\right]}}\\
=\sum_{j}{\Prob(N_{c,b}=j)\sum_{i =1}^{j}{ r(c,p)(1+f(c))}}\\
=\sum_{j}{\Prob(N_{c,b}=j) jr(c,p)(1+f(c))}
\end{align*}
}

\section{Step 2}
We model the online learning problem as follows:
\begin{itemize}
\item The time steps are the single days. We consider the days as numbered from 1 to the learning horizon $H$.
\item The learning horizon $H$ is 365.
\item The learner will try a sequence of prices $(p_1, ..., p_H)$, $p_i \in P$.
\item The learner will try a sequence of bids $(b_1, ..., b_H)$, $b_i \in B$.
\item The full feedback of time step $t$ (the total profit generated from the users that clicked on the ad for the first time on time step $t$) is received after a delay of 30 time steps. The full feedback of time step $t$ is the sum of different profits that can come with different delays with respect to $t$.
\item Until time step 30, the learner will use all the partial feedbacks of the previous time steps as if they were complete. After that, the feedbacks will always be complete.
\end{itemize}

The objective function to maximize is the cumulative expected profit over the learning horizon $H$:

\begin{align*}
\EX\left[\sum_{t=1}^H{\sum_{c \in C}{n(c,b_t)r(c,p_t)m(p_t)(1+\EX[f(c)])-n(c,b_t)cost}}\right]
\end{align*}

\appendix
\section{Derivation of ExpectedProfit}\label{sec.DerExpProf}
\begin{align*}
ExpectedProfit(p,b) 
&= \EX\left[\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}{\bigg( D_{c,p,i}(1+F_{c,i})m(p)-k(b)\bigg)}}\right]\\
&= \EX\left[\sum_{c \in C}{\bigg(\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})m(p)}-\sum_{i =1}^{N_{c,b}}k(b)\bigg)}\right]\\
&= \EX\left[\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})m(p)}}-\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}k(b)}\right]\\
&= \EX\left[\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})m(p)}}-\sum_{c \in C}{N_{c,b}k(b)}\right]\\
&= \EX\left[\sum_{c \in C}{\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})m(p)}}\right]-\sum_{c \in C}{\EX[N_{c,b}]k(b)}\\
&= m(p)\sum_{c \in C}{\EX\left[\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})}\right]}-\sum_{c \in C}{n(c,b)k(b)}\\
&= m(p)\sum_{c \in C}{\EX\left[\EX\left[\sum_{i =1}^{N_{c,b}}{ D_{c,p,i}(1+F_{c,i})}\Bigg|N_{c,b}\right]\right]}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{\EX\left[\sum_{i =1}^{N_{c,b}}{\EX\left[D_{c,p,i}(1+F_{c,i})\bigg|N_{c,b}\right]}\right]}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{\EX\left[\sum_{i =1}^{N_{c,b}}{\EX\left[D_{c,p,i}\bigg|N_{c,b}\right]\EX\left[(1+F_{c,i})\bigg|N_{c,b}\right]}\right]}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{\EX\left[\sum_{i =1}^{N_{c,b}}{r(c,p)\Big(1+f(c)\Big)}\right]}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{\EX\left[N_{c,b}r(c,p)\Big(1+f(c)\Big)\right]}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{\EX\left[N_{c,b}\right]r(c,p)\Big(1+f(c)\Big)}-k(b)\sum_{c \in C}{n(c,b)}\\
&= m(p)\sum_{c \in C}{n(c,b)r(c,p)\Big(1+f(c)\Big)}-k(b)\sum_{c \in C}{n(c,b)}
\end{align*}

\section{Proof of the Contant optimal price Lemma}\label{sec.ConstOptPrice}
\begin{align*}
ExpectedProfit(p,b)=\sum_{c \in C}{n(c,b)r(c,p)m(p)(1+f(c))}-k(b)\sum_{c \in C}{n(c,b)}
\end{align*}
The partial derivative with respect to p is:
\begin{align*}
\frac{\partial ExpectedProfit(p,b)}{\partial p}=\sum_{c \in C}{n(c,b)(1+f(c))\bigg(\frac{\partial r(c,p)}{\partial p}m(p) + r(c,p)\frac{\partial m(p)}{\partial p}\bigg)}
\end{align*}
The derivative can be seen as the scalar product of two $|C|$-dimensional vectors $\underline n(b)$ and $\underline s(p)$, where the c-th element of $\underline n(b)$ is $n(c,b)$ and the c-th element of $\underline s(p)$ is $(1+f(c))\bigg(\frac{\partial r(c,p)}{\partial p}m(p) + r(c,p)\frac{\partial m(p)}{\partial p}\bigg)$.
\begin{align*}
\frac{\partial ExpectedProfit(p,b)}{\partial p}=\underline n(b)\cdot \underline s(p)
\end{align*}
Let's assume that in $(p*, \overline b)$ the partial derivative equals 0:
\begin{align*}
\underline n(\overline b)\cdot \underline s(p*) = 0
\end{align*}
Let's focus on the vector $\underline n(b)$: it holds that $\forall b \ \forall d \ \exists \gamma \  | \ \underline n(b + d)=\gamma\underline n(b)$.

This can be shown element-wise:
\begin{align*}
\frac{n(c, b+d)}{n(c,b)} = \frac{n(c)v(b+d)}{n(c)v(b)} = \frac{v(b+d)}{v(b)} = \gamma
\end{align*}
Therefore
\begin{align*}
\left.\frac{\partial ExpectedProfit(p,b)}{\partial p}\right\rvert_{p=p*, b=\overline b+d}=\underline n(\overline b+d)\cdot \underline s(p*) = \gamma \underline n(\overline b)\cdot \underline s(p*) = 0
\end{align*}
\end{document}
